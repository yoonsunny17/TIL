# 07_deadlocks

**교착상태란?**

* 각자 일부 자원을 가지고 있으면서 상대가 가지고 있는 것을 요구함
* 자원은 하드웨어, 소프트웨어를 모두 포함하는 개념

교착상태의 필요 조건

* 상호 배제
* 비선점
  * 한 프로세스가 사용 중인 자원은 중간에 다른 프로세스가 뺏을 수 없는 비선점 자원이어야 함
* 점유와 대기
  * 자원을 가진 프로세스가 다른 자원을 기다릴 때 보유 자원을 놓지 않고 계속 가지고 있음/프로세스가 어떤 자원을 할당받은 상태에서 다른 자원을 기다리는 상태여야 함
* 원형대기
  * 자원을 기다리는 프로세스간에 사이클이 형성되어야 함

자원할당 그래프

* 교착상태의 발생 여부를 알아보는 도구
* 프로세스가 어떤 자원을 사용 중이고 어떤 자원을 기다리고 있는지를 방향성이 없는 것을 그래프로 표현한 것
* 구성요소
  * 큰 원 프로세스
  * 사각형 자원
  * 실선 화살표
    * 프로세스가 자원을 사용중인 경우 // 자워 => 프로세스
    * 프로세스가 자원을 요청했고 아직 획득하지 못한 상태 // 프로세스 => 자원
  * 점선 화살표 프로세스가 그 자원을 언젠가 반드시 한 번은 요청 // 프로세스 => 자원
  * 작은 동그라미 자원의 인스턴스 수
* 사이클이 존재하더라도 모든 자원에 인스턴스가 하나뿐이라면 사이클의 발생은 곧 교착상태를 의미하지만, 다중상태가 있다면 반드시 교착상태가 있다고 할 수는 없음

교착 상태를 예방하는 방법 (각 발생 방법에 대한 4가지 예방 방법)

* 상호배제 예방
  * 상호배타적인 자원을 없애고 공유 가능한 자원만을 남기는 것
  * 현실적으로 무리
* 비선점 예방
  * 쉽게말해서 자원을 도중에 빼앗을 수 있도록 하는 방법
  * 빼앗을 수 있는 기준, 빼앗은 후 얼마나 사용하게 될지 등 정해야 할 기준이 많다는 문제 존재, 또한 starvation 문제를 일으킬 수 있음
* 점유와 대기 예방
  * 자원을 전부 할당하거나 아니면 아예 할당받지 못하게 하여 프로세스가 자원을 점유한 상태에서 다른 자원을 기다리지 못하게 하는 방법
  * 방법 1. 프로세스 시작 시 모든 필요한 자원을 할당받게 하는 방법
    * 프로세스가 매 순간마다 필요한 자원이 다른데, 시작부터 모든 자원을 할당받으면 사용하지않을 때 그 자원ㅇ르 다른 프로세스가 사용할 수 없으므로 비효율성 문제

정리

* 현실적으로 자원의 이용률이 낮아지고, 시스템 성능의 저하, starvation 문제 등으로 인해 사용이 어려움



single instance 자원할당 그래프

* 교착상태가 발생할 가능성이 없을 때만 요청을 들어줌
* (그림을 보고 이해하는 것이 좋음)

multiple instances: 은행원 알고리즘

* 기본 가정
  * 모든 프로세스는 자원의 최대 사용량을 미리 명시
  * 프로세스가 요청 자원을 모두 할당받으면 유한 시간 안에 이들 자원을 다시 반납
* ㅂㅏㅇ법
  * 시스템이 안정상태를 유지하는 한도에서 자원을 할당
  * 이후 자원을 반납받고, 모든 프로세스가 종료될 때까지 반복
  * 혹시모를 상황을 대비하여 자원이 남더라도 할당해주지 않기 때문에 비효율적



deadlock detection algorithm

Single-instance

* 사이클이 존재하는지 찾는데 드는 오버헤드 O(n^2) => 오래걸림 비효율적

multiple-instances

* 상황을 최대한 낙관적으로 봄



Time out에 의한 검출



~ 교착단계 검출 후 회복 단계로 진입

recovery

* 방법 1. 교착 상태가 발견된 경우 연루된 모든 프로세스를 강제 종료하는 방법
* 방법 2. 교착 상태에 연루된 프로세스들 중 하나씩 선택하여 순서대로 종료시키면서 나머지 프로세스의 상태를 확인하는 방법

deadlock ignorance

* deadlock이 발생하던 말던.. 걍 무시
* 실제로 dealock은 드물게 발생하므로 그것을 예방하기 위한 조치 자체가 더 큰 overhead일 수 있다는 것
* 시스템은 아무런 관여를 하지 않고, 시스템이 비정상적이라는 것을 사람이 느꼈을 경우 직접 process를 죽이는 방법으로 대처
* 이 방법을 오늘날 대부분의 os 가 채택